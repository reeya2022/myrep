http://192.168.154.129/myapp/webroot/index.php


公式のcakephp4インストール手順
https://book.cakephp.org/4/ja/installation.html

公式のコーディング規約
https://book.cakephp.org/4/ja/contributing/cakephp-coding-conventions.html

↓入門用によくまとまっている参考記事
https://tt-computing.com/cake4-install


.envとapp_local.phpについて
https://tech-gineer.com/cakephp4/70/
https://codesapuri.com/articles/7

	もともと.envが使われていたっぽいのとコンテナベースだと.envを使うっぽいので.envを使うことにする
	というか両方使った方が良さそう。なのでapp_local.phpと.env両方使う


【重要】環境によって変わるファイルはgitの対象にしてはいけない

	app.phpの場合、app.default.phpをgit管理にしておけば、app.default.phpに変更があってもapp.phpには影響ない(conflictが起きない)
	(そもそもkarigoのdefine.phpは環境依存する変数とそうでない定数がごっちゃになっているからマズイ)



ORマッパーの条件の指定について
https://moewe-net.com/cakephp/orm-query

conditionsでもwhereでもどっちでもいいっぽい

find('all') よりも find()->all()の方がcakephp3以降に導入されたやり方なのでこっちの方がいい？

//cake2
$params = array(
  'conditions' => array('year' => '2015'),
  'fields' => array('id', 'title'),
  'order' => array('id' => 'ASC'),
  'limit' => 10,
  'contain' => array('Tag'),
);
$data = $this->Post->find('all', $params);

//cake3
$data = $this->Posts->find()
        ->select(['id', 'title'])
        ->where(['year' => '2015'])
        ->order(['id' => 'ASC'])
        ->limit(10)
        ->contain(['Tag'])
        ->all();

※update()もsave()を使わずにメソッドチェーンでかけるっぽい

Posts->query()->update()
			  ->set(['title'=>'test'])
			  ->where(['id'=>'1'])
			  ->execute();


クエリーを全部ログに出す方法
https://blog.s-giken.net/328.html
logs/queries.log に出力する


//データ更新について
バリデーションする場合はpatchEntity()を実行するけどバリデーション不要の場合は↓みたいな感じになる

$user = $this->User->newEntity(); ※newEmptyEntity()の方が良いかも？

$user->id = 1;
$user->status = 0;

if ($this->User->save($user)) {
}



//cake4のモデルについて
・find()だとクエリ型を取得するので、データ(エンティティ)型にするにはさらにtoList()とかを実行しないといけない
・get()だと直接データ(エンティティ)型を取得することができる



//find()について
find('all')もfind('list')も返すデータはクエリ型でどちらも同じ。流れるクエリも同じ。ただしtoList()とかを実行した後の結果が変わる

find('all')->toList() ・・・ エンティティ型
find('list')->toList() ・・・ 連想配列
find('')->toList() ・・・・  find()もfind('all')と同じっぽい
find('all')->all() ・・・・・ResultSetオブジェクトになる

find('list')の場合、keyFieldとvalueFieldを指定可能
find('list',['keyField'=>'id','valueField'=>'name'])




//デバッグについて
pr()よりもdebug()やdd()の方が良さそう。行番号も表示してくれるし。

debug()
dd() → exitしてくれる



//formhelperについて
https://book.cakephp.org/4/ja/views/helpers/form.html
めちゃくちゃ便利だから絶対使うべき

$this->Form->control
$this->Form->text

control使うか各input使うかどちらでも良い
各input使えば余計なdivで囲まれることがないので使い分けること(ただしidとかも付与されなくなるので注意)

※controlでないとエラーメッセージが表示されない(class="form-error"が追加されるだけ)
※その場合、テンプレート側で$this->Form->error()を実行する必要がある。


submitはcontrol使わないこと。submit or button(type) を使う



//バリデーションについて
https://qiita.com/azukiazusa/items/9e8bbe461bdbc7ee572c
cakephpで使用可能なバリデーション一覧




//エンティティについて
まずキャッシュが無効になっていること

●分かったこと
バリデーションはテーブルクラス、データをごにょごにょしたい場合はエンティティ、という区別で良さそう。

エンティティを変更したい場合はset()を使えばよい。

エンティティのセッター(_set)はset()を呼んだ時や、patchEntityでも呼ばれる。
ただし、データがセットされていない場合は呼ばれない。(workdayではまった)

今回試したworkdayのように、postされた値を整形して保存したい、といった場合。(今回は文字列型ではなく配列→文字列だったから余計大変だった。)

	まず普通にバリデーションする
	その後、エンティティに整形するメソッドを定義してその中で整形する
	後はsaveすればok



//patchEntityでデータが消える件
https://qiita.com/satthi/items/0bb3ae3d6c12f66e6487
DBの型と渡した型が違うと消えたりnullになったりするっぽい

日付も/だと消えたｗ -に変換してやる必要がありそう



//ajaxについて
https://tt-computing.com/cake4-csrf-disabled
そのままだとcsrfの保護で403エラーになる
なので特定のアクションのみCsrfProtectionMiddlewareのskipCheckCallbackで許可してやる必要がある

アクション側ではレンダーをオフにするため↓が必要
$this->autoRender = false; 




//キャッシュについて
開発の際、cakeのキャッシュは必ず無効にすること。ONのままだと開発に支障が出まくる

https://tt-computing.com/cake4-cache-clear
(消さない)何か変だなと思ったら即cache_clearすること(特にモデル回り)




//トランザクションについて
これまで通りbegin()〜commit()するやり方と、transactional()を使う2つの方法があるっぽい。
begin()〜commit()だと記述が若干冗長になるっぽいので、transactional()を使った方が良いかも。






